<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faynalytics - Trading Journal & Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for Light and Dark Theme */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 6px 12px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --accent-primary: #8b5cf6;
            --accent-secondary: #7c3aed;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
        }

        [data-theme="dark"] {
            --bg-primary: #1e293b;
            --bg-secondary: #0f172a;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 6px 12px -2px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            --accent-primary: #a78bfa;
            --accent-secondary: #c4b5fd;
        }

        * {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Re-usable components */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        .input-label {
            position: absolute;
            top: -0.5rem;
            left: 0.75rem;
            background: var(--bg-primary);
            padding: 0 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--accent-secondary), var(--accent-primary));
            color: white;
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }
        
        .btn-info:hover {
            opacity: 0.9;
        }
        
        /* Layout & Structure */
        .main-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background-color: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 50;
            overflow-y: auto;
            transform: translateX(-100%);
        }
        
        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 280px;
            }
        }
        
        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 0.75rem;
            margin: 0.5rem 0;
            transition: all 0.2s ease;
        }
        
        .nav-item:hover {
            background: var(--bg-secondary);
            color: var(--accent-primary);
        }

        .nav-item.active {
            background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary));
            color: white;
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.2);
        }

        /* Section visibility logic */
        .section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Other specific styles */
        .header-glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .header-glass {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-card {
            border-left: 4px solid var(--accent-primary);
        }

        .status-indicator.online {
            animation: pulse-ring 1.5s infinite;
        }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            100% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary));
        }

        .table-container {
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .table th, .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background-color: var(--bg-tertiary);
        }
        
        .journal-entry-card {
            border-left: 4px solid;
        }
    </style>
</head>
<body data-theme="light">
    
    <div class="main-container">
        <div class="sidebar lg:sticky lg:top-0" id="sidebar">
            <div class="p-6 mb-8">
                <div class="flex items-center justify-between">
                    <h2 class="text-3xl font-extrabold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">
                        Faynalytics
                    </h2>
                    <button class="lg:hidden p-2 text-gray-500 hover:text-gray-700" id="closeSidebar">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <nav>
                <a href="#" class="nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-section="calculator">
                    <i class="fas fa-calculator"></i>
                    <span>Position Calculator</span>
                </a>
                <a href="#" class="nav-item" data-section="journal">
                    <i class="fas fa-book"></i>
                    <span>Trading Journal</span>
                </a>
                <a href="#" class="nav-item" data-section="analytics">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-item" data-section="sessions">
                    <i class="fas fa-clock"></i>
                    <span>Market Sessions</span>
                </a>
                <a href="#" class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>
        
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <div class="main-content flex-1 p-4 lg:p-8">
            <header class="header-glass sticky top-4 z-40 p-4 mb-8 rounded-2xl flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button class="lg:hidden btn btn-primary p-2" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                            Faynalytics
                        </h1>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Manage your risk and track your performance</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="theme-toggle w-16 h-8 rounded-full cursor-pointer relative" id="themeToggle">
                        <div class="w-6 h-6 rounded-full bg-white absolute top-1 left-1 transform transition-transform duration-300 ease-in-out shadow-md"></div>
                    </div>
                    
                    <button class="relative p-2 text-gray-600 dark:text-gray-400 hover:text-purple-600 transition-colors">
                        <i class="fas fa-bell"></i>
                        <span class="absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                    </button>
                    
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-600 to-blue-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                    </div>
                </div>
            </header>

            <div id="dashboardSection" class="section active">
                <div class="card p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-cloud text-purple-600"></i>
                        Cloud Sync
                    </h2>
                    <div id="userNameDisplay" class="hidden text-center text-lg font-semibold mb-4 text-green-600"></div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <button id="authorizeButton" class="btn btn-primary lg:col-span-2">
                            <i class="fab fa-google"></i>
                            Connect to Google Drive
                        </button>
                        <button id="signoutButton" class="btn btn-danger hidden lg:col-span-2">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign Out
                        </button>
                        <button id="saveToDriveButton" class="btn btn-info hidden">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Save to Drive
                        </button>
                        <button id="loadFromDriveButton" class="btn btn-success hidden">
                            <i class="fas fa-cloud-download-alt"></i>
                            Load from Drive
                        </button>
                    </div>
                    
                    <div id="driveStatus" class="mt-4 text-sm text-gray-500 text-center">Not connected to Google Drive.</div>
                    <div id="authErrorMessage" class="hidden mt-3 p-3 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-lg"></div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card card p-6">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Total Trades</p>
                        <p id="totalTrades" class="metric-value font-bold text-3xl">0</p>
                    </div>
                    
                    <div class="metric-card card p-6">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Win Rate</p>
                        <p id="winRate" class="metric-value font-bold text-3xl">0.00%</p>
                    </div>
                    
                    <div class="metric-card card p-6">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Total P&L</p>
                        <p id="totalPnL" class="metric-value font-bold text-3xl">€0.00</p>
                    </div>
                    
                    <div class="metric-card card p-6">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Avg P&L</p>
                        <p id="avgPnL" class="metric-value font-bold text-3xl">€0.00</p>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-bullseye text-purple-600"></i>
                        Performance Goal
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                        <div class="input-group">
                            <label class="input-label">Initial Capital (€)</label>
                            <input type="number" id="initialCapital" class="input" value="10000">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Target P&L (€)</label>
                            <input type="number" id="targetPnLEuro" class="input" value="1000">
                        </div>
                        <div class="flex items-end">
                            <button onclick="setPerformanceGoal()" class="btn btn-primary w-full">
                                <i class="fas fa-bullseye"></i>
                                Set Goal
                            </button>
                        </div>
                    </div>
                    
                    <div id="goalProgressDisplay" class="hidden">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium">Progress</span>
                            <span id="currentGoalProgress" class="text-sm font-bold text-purple-600">0.00%</span>
                        </div>
                        <div class="progress-bar h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div id="goalProgressBar" class="progress-fill h-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="calculatorSection" class="section">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-calculator text-purple-600"></i>
                        Position Size Calculator
                    </h2>
                    
                    <div id="calcErrorMessage" class="hidden mb-4 p-3 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-lg"></div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="input-group">
                            <label class="input-label">Account Capital (€)</label>
                            <input type="number" id="capital" class="input" value="1000" min="1" step="any">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Risk Percentage per Trade (%)</label>
                            <input type="number" id="riskPercentage" class="input" value="1" min="0.1" max="10" step="0.1">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Currency Pair / Asset</label>
                            <select id="currencyPair" class="input">
                                <option value="EURUSD">EUR/USD</option>
                                <option value="GBPUSD">GBP/USD</option>
                                <option value="USDJPY">USD/JPY</option>
                                <option value="AUDUSD">AUD/USD</option>
                                <option value="USDCAD">USD/CAD</option>
                                <option value="USDCHF">USD/CHF</option>
                                <option value="NZDUSD">NZD/USD</option>
                                <option value="EURJPY">EUR/JPY</option>
                                <option value="GBPJPY">GBP/JPY</option>
                                <option value="XAUUSD">Gold (XAU/USD)</option>
                                <option value="DAX40">DAX 40 (Germany)</option>
                                <option value="SP500">S&P 500 (USA)</option>
                                <option value="NASDAQ100">NASDAQ 100 (USA)</option>
                                <option value="CAC40">CAC 40 (France)</option>
                                <option value="custom">Other (enter pip value)</option>
                            </select>
                        </div>
                        
                        <div id="customPipValueContainer" class="input-group hidden">
                            <label class="input-label">Pip/Point Value per Standard Lot (€)</label>
                            <input type="number" id="customPipValue" class="input" value="10" min="0.01" step="any">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Stop Loss Input Method</label>
                            <select id="stopLossInputMethod" class="input">
                                <option value="pips_direct">Enter Pips Directly</option>
                                <option value="price_based">Calculate Pips from Price</option>
                            </select>
                        </div>
                        
                        <div id="pipsDirectInputContainer" class="input-group">
                            <label class="input-label">Stop Loss (in Pips)</label>
                            <input type="number" id="stopLossPips" class="input" value="20" min="1" step="any">
                        </div>
                        
                        <div id="priceBasedInputContainer" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="input-group">
                                <label class="input-label">Entry Price</label>
                                <input type="number" id="entryPrice" class="input" step="any">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Stop Loss Price</label>
                                <input type="number" id="stopLossPrice" class="input" step="any">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Trade Type</label>
                                <select id="tradeTypeForSL" class="input">
                                    <option value="buy">Buy</option>
                                    <option value="sell">Sell</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="calculatePositionSize()" class="btn btn-primary w-full mt-6">
                        <i class="fas fa-calculator"></i>
                        Calculate Position Size
                    </button>
                    
                    <div id="resultBox" class="hidden mt-6 p-6 bg-blue-50 dark:bg-blue-900 rounded-lg border border-blue-200 dark:border-blue-700">
                        <h4 class="font-semibold mb-4 text-blue-800 dark:text-blue-200">Calculation Results</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Position Size</p>
                                <p id="lotSize" class="text-3xl font-bold text-blue-600 dark:text-blue-400">0.00</p>
                                <p class="text-sm text-gray-500">lots</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Pip Value</p>
                                <p id="pipValueDisplay" class="text-3xl font-bold text-blue-600 dark:text-blue-400">€0.00</p>
                                <p class="text-sm text-gray-500">€</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Amount Risked</p>
                                <p id="amountRisqued" class="text-3xl font-bold text-blue-600 dark:text-blue-400">€0.00</p>
                                <p class="text-sm text-gray-500">€</p>
                            </div>
                        </div>
                        <div id="calculatedPipsDisplay" class="hidden text-center mt-4 pt-4 border-t border-blue-200 dark:border-blue-700">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Calculated Pips</p>
                            <p id="calculatedPips" class="text-xl font-semibold">0.0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="journalSection" class="section">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-book text-purple-600"></i>
                        Trading Journal
                    </h2>
                    
                    <div id="journalErrorMessage" class="hidden mb-4 p-3 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-lg"></div>
                    
                    <form id="journalForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <div class="input-group">
                            <label class="input-label">Date</label>
                            <input type="date" id="journalDate" class="input" required>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Asset</label>
                            <select id="journalAssetSelect" class="input">
                                <option value="EURUSD">EUR/USD</option>
                                <option value="GBPUSD">GBP/USD</option>
                                <option value="USDJPY">USD/JPY</option>
                                <option value="AUDUSD">AUD/USD</option>
                                <option value="USDCAD">USD/CAD</option>
                                <option value="USDCHF">USD/CHF</option>
                                <option value="NZDUSD">NZD/USD</option>
                                <option value="EURJPY">EUR/JPY</option>
                                <option value="GBPJPY">GBP/JPY</option>
                                <option value="XAUUSD">Gold (XAU/USD)</option>
                                <option value="DAX40">DAX 40 (Germany)</option>
                                <option value="SP500">S&P 500 (USA)</option>
                                <option value="NASDAQ100">NASDAQ 100 (USA)</option>
                                <option value="CAC40">CAC 40 (France)</option>
                                <option value="other">Other (enter name)</option>
                            </select>
                            <input type="text" id="journalAssetCustom" class="input mt-2 hidden" placeholder="Enter asset name">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Trade Type</label>
                            <select id="journalTradeType" class="input">
                                <option value="Buy">Buy (Long)</option>
                                <option value="Sell">Sell (Short)</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Setup</label>
                            <input type="text" id="journalSetup" class="input" placeholder="Ex: Resistance breakout, MA rejection">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Entry Price</label>
                            <input type="number" id="journalEntryPrice" class="input" step="any" required>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Stop Loss</label>
                            <input type="number" id="journalSL" class="input" step="any" required>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Take Profit</label>
                            <input type="number" id="journalTP" class="input" step="any" required>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">RRR (Ex: 1:2)</label>
                            <input type="text" id="journalRRR" class="input" placeholder="Ex: 1:2">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Position Size</label>
                            <input type="number" id="journalPositionSize" class="input" step="any" required>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Result (€)</label>
                            <input type="number" id="journalResultEuro" class="input" step="any">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Result (%)</label>
                            <input type="number" id="journalResultPercentage" class="input" step="any">
                        </div>
                        
                        <div class="input-group lg:col-span-3">
                            <label class="input-label">Comment / Emotion</label>
                            <textarea id="journalComment" class="input h-32" placeholder="Notes on the trade, felt emotions..."></textarea>
                        </div>
                    </form>
                    
                    <div class="flex flex-col sm:flex-row gap-3 mb-6">
                        <button type="button" class="btn btn-success flex-1" onclick="addUpdateJournalEntry(false)">
                            <i class="fas fa-plus"></i>
                            Add to Journal
                        </button>
                        <button type="button" class="btn btn-info flex-1" onclick="addUpdateJournalEntry(true)">
                            <i class="fas fa-save"></i>
                            Save Draft
                        </button>
                        <button type="button" class="btn btn-danger hidden flex-1" id="cancelEditBtn" onclick="cancelEdit()">
                            <i class="fas fa-times"></i>
                            Cancel Edit
                        </button>
                    </div>
                    
                    <div class="card p-6 mb-6">
                        <h4 class="font-semibold mb-4 flex items-center gap-2">
                            <i class="fas fa-filter text-purple-600"></i>
                            Filter & Sort Options
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="input-group m-0">
                                <label class="input-label">Filter by Asset</label>
                                <select id="filterAssetSelect" class="input" onchange="applyFiltersAndSort()">
                                    <option value="">All</option>
                                    <option value="EURUSD">EUR/USD</option>
                                    <option value="GBPUSD">GBP/USD</option>
                                    <option value="USDJPY">USD/JPY</option>
                                    <option value="AUDUSD">AUD/USD</option>
                                    <option value="USDCAD">USD/CAD</option>
                                    <option value="USDCHF">USD/CHF</option>
                                    <option value="NZDUSD">NZD/USD</option>
                                    <option value="EURJPY">EUR/JPY</option>
                                    <option value="GBPJPY">GBP/JPY</option>
                                    <option value="XAUUSD">Gold (XAU/USD)</option>
                                    <option value="DAX40">DAX 40</option>
                                    <option value="SP500">S&P 500</option>
                                    <option value="NASDAQ100">NASDAQ 100</option>
                                    <option value="CAC40">CAC 40</option>
                                </select>
                            </div>
                            
                            <div class="input-group m-0">
                                <label class="input-label">Filter by Trade Type</label>
                                <select id="filterTradeType" class="input" onchange="applyFiltersAndSort()">
                                    <option value="">All</option>
                                    <option value="Buy">Buy</option>
                                    <option value="Sell">Sell</option>
                                </select>
                            </div>
                            
                            <div class="input-group m-0">
                                <label class="input-label">Sort by</label>
                                <select id="sortBy" class="input" onchange="applyFiltersAndSort()">
                                    <option value="timestamp">Date</option>
                                    <option value="resultEuro">Result (€)</option>
                                    <option value="resultPercentage">Result (%)</option>
                                    <option value="asset">Asset</option>
                                </select>
                            </div>
                            
                            <div class="input-group m-0">
                                <label class="input-label">Order</label>
                                <select id="sortOrder" class="input" onchange="applyFiltersAndSort()">
                                    <option value="desc">Descending</option>
                                    <option value="asc">Ascending</option>
                                </select>
                            </div>
                        </div>
                        
                        <button onclick="resetFiltersAndSort()" class="btn btn-danger mt-4">
                            <i class="fas fa-undo"></i>
                            Reset Filters
                        </button>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-xl mb-4">Journal Entries</h4>
                        <p class="text-center text-gray-600 dark:text-gray-400 p-4" id="noEntriesMessage">No journal entries yet. Add your first trade!</p>
                        <div id="journalEntriesContainer" class="space-y-6"></div>
                    </div>
                </div>
            </div>

            <div id="analyticsSection" class="section">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                            <i class="fas fa-chart-line text-purple-600"></i>
                            Equity Curve
                        </h3>
                        <div class="chart-container h-64 md:h-80">
                            <canvas id="equityCurveChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                            <i class="fas fa-chart-bar text-purple-600"></i>
                            Asset Performance
                        </h3>
                        <div class="chart-container h-64 md:h-80">
                            <canvas id="assetPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-table text-purple-600"></i>
                        Detailed Statistics
                    </h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-medium mb-3 text-lg">Performance by Asset</h4>
                            <div id="performanceByAssetTable" class="table-container overflow-x-auto">
                                <p class="text-center text-gray-600 dark:text-gray-400 p-4">No asset data available.</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-medium mb-3 text-lg">Performance by Trade Type</h4>
                            <div id="performanceByTradeTypeTable" class="table-container overflow-x-auto">
                                <p class="text-center text-gray-600 dark:text-gray-400 p-4">No trade type data available.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sessionsSection" class="section">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-clock text-purple-600"></i>
                        Trading Sessions Status (UTC)
                    </h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl text-center shadow-sm">
                            <div class="flex items-center justify-center mb-2">
                                <div id="londonStatus" class="status-indicator w-3 h-3 rounded-full"></div>
                                <span class="font-medium">London</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">08:00 - 16:00</p>
                        </div>
                        
                        <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl text-center shadow-sm">
                            <div class="flex items-center justify-center mb-2">
                                <div id="newYorkStatus" class="status-indicator w-3 h-3 rounded-full"></div>
                                <span class="font-medium">New York</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">13:00 - 21:00</p>
                        </div>
                        
                        <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl text-center shadow-sm">
                            <div class="flex items-center justify-center mb-2">
                                <div id="tokyoStatus" class="status-indicator w-3 h-3 rounded-full"></div>
                                <span class="font-medium">Tokyo</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">00:00 - 09:00</p>
                        </div>
                        
                        <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl text-center shadow-sm">
                            <div class="flex items-center justify-center mb-2">
                                <div id="sydneyStatus" class="status-indicator w-3 h-3 rounded-full"></div>
                                <span class="font-medium">Sydney</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">22:00 - 07:00</p>
                        </div>
                    </div>
                    
                    <div class="chart-container h-64 md:h-80">
                        <canvas id="tradingSessionsChartCanvas"></canvas>
                    </div>
                </div>
            </div>

            <div id="settingsSection" class="section">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-cog text-purple-600"></i>
                        Settings
                    </h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Appearance</h3>
                            <div class="flex items-center justify-between p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                                <span class="text-gray-700 dark:text-gray-300">Dark Mode</span>
                                <div class="theme-toggle w-16 h-8 rounded-full cursor-pointer relative" id="settingsThemeToggle">
                                    <div class="w-6 h-6 rounded-full bg-white absolute top-1 left-1 transform transition-transform duration-300 ease-in-out shadow-md"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Data Management</h3>
                            <div class="space-y-3">
                                <button class="btn btn-info w-full" onclick="exportData()">
                                    <i class="fas fa-download"></i>
                                    Export Journal Data
                                </button>
                                <button class="btn btn-warning w-full" onclick="importData()">
                                    <i class="fas fa-upload"></i>
                                    Import Journal Data
                                </button>
                                <button class="btn btn-danger w-full" onclick="clearAllData()">
                                    <i class="fas fa-trash"></i>
                                    Clear All Data
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Notifications</h3>
                            <div class="space-y-3 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" class="mr-3 form-checkbox h-5 w-5 text-purple-600" id="goalNotifications">
                                    <span class="text-gray-700 dark:text-gray-300">Goal achievement notifications</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" class="mr-3 form-checkbox h-5 w-5 text-purple-600" id="sessionNotifications">
                                    <span class="text-gray-700 dark:text-gray-300">Market session notifications</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg text-center shadow-lg">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-t-4 border-gray-200 dark:border-gray-700 border-t-purple-600 mx-auto mb-4"></div>
            <p class="text-sm font-medium">Loading...</p>
        </div>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // Application State
        const appState = {
            currentSection: 'dashboard',
            theme: localStorage.getItem('theme') || 'light',
            journalEntries: [],
            editingEntryIndex: -1,
            initialCapital: 10000,
            targetPnLEuro: 1000,
            charts: {
                equity: null,
                asset: null,
                tradeType: null,
                sessions: null
            }
        };

        // Constants
        const LOCAL_STORAGE_KEY = 'tradingJournalEntries';
        const GOAL_STORAGE_KEY = 'tradingPerformanceGoal';
        const CLIENT_ID = '785515460632-mkritbmoj148ogofsvvndb1nsch8que2.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBjCi7NLfdJGcLGM3sWW5wGqRT58arVj6c';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

        // Google API variables
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let googleAccessToken = null;
        let googleUserId = null;
        let authReady = false;

        // ========================================================================
        // FONCTIONS D'INITIALISATION ET DE GESTION DE GOOGLE DRIVE (PORTÉE GLOBALE)
        // ========================================================================

        // Les fonctions ci-dessous sont définies dans la portée globale (window)
        // pour être accessibles par les attributs 'onload' des scripts.
        window.gapiLoaded = function() {
            gapi.load('client', initializeGapiClient);
        }

        window.gisLoaded = function() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        googleAccessToken = tokenResponse.access_token;
                        gapi.client.setToken(tokenResponse);
                        updateAuthUI(true);
                        showToast("Connected to Google Drive!", 'success');
                    } else {
                        showToast("Failed to connect to Google Drive.", 'error');
                    }
                }
            });
            gisInited = true;
            maybeEnableGoogleAuthButtons();
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: DISCOVERY_DOCS,
                });
                gapiInited = true;
                maybeEnableGoogleAuthButtons();
            } catch (error) {
                console.error("Error initializing GAPI client:", error);
                showToast("Failed to initialize Google API. Check network and API key.", 'error');
            }
        }
        
        function maybeEnableGoogleAuthButtons() {
            if (gapiInited && gisInited) {
                const token = gapi.client.getToken();
                if (token && token.access_token) {
                    googleAccessToken = token.access_token;
                    updateAuthUI(true);
                } else {
                    updateAuthUI(false);
                }
                authReady = true;
            }
        }
        
        function handleAuthClick() {
            if (!authReady) {
                showToast("Google client not ready. Please try refreshing the page.", 'warning');
                return;
            }
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    googleAccessToken = null;
                    googleUserId = null;
                    updateAuthUI(false);
                    appState.journalEntries = [];
                    saveJournalEntriesLocallyOnly();
                    loadData();
                    showToast("Signed out from Google Drive.", 'info');
                });
            }
        }
        
        async function updateAuthUI(isSignedIn) {
            const authBtn = document.getElementById('authorizeButton');
            const signoutBtn = document.getElementById('signoutButton');
            const saveBtn = document.getElementById('saveToDriveButton');
            const loadBtn = document.getElementById('loadFromDriveButton');
            const statusDiv = document.getElementById('driveStatus');
            const userDisplay = document.getElementById('userNameDisplay');

            if (isSignedIn) {
                authBtn.classList.add('hidden');
                signoutBtn.classList.remove('hidden');
                saveBtn.classList.remove('hidden');
                loadBtn.classList.remove('hidden');
                statusDiv.textContent = 'Connected to Google Drive.';
                userDisplay.classList.remove('hidden');
                await fetchUserInfo();
            } else {
                authBtn.classList.remove('hidden');
                signoutBtn.classList.add('hidden');
                saveBtn.classList.add('hidden');
                loadBtn.classList.add('hidden');
                statusDiv.textContent = 'Not connected to Google Drive.';
                userDisplay.classList.add('hidden');
            }
        }

        async function fetchUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                });
                if (response.ok) {
                    const userInfo = await response.json();
                    googleUserId = userInfo.id;
                    document.getElementById('userNameDisplay').textContent = `Welcome, ${userInfo.given_name || 'Trader'}!`;
                }
            } catch (error) {
                console.error('Failed to fetch user info:', error);
            }
        }
        
        const APP_FOLDER_NAME = 'Faynalytics Data';
        let appFolderId = null;

        async function getAppFolderId() {
            if (appFolderId) return appFolderId;
            try {
                const res = await gapi.client.drive.files.list({
                    q: `mimeType='application/vnd.google-apps.folder' and name='${APP_FOLDER_NAME}'`,
                    fields: 'files(id)'
                });
                if (res.result.files.length > 0) {
                    appFolderId = res.result.files[0].id;
                } else {
                    const createRes = await gapi.client.drive.files.create({
                        resource: { name: APP_FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' },
                        fields: 'id'
                    });
                    appFolderId = createRes.result.id;
                }
                return appFolderId;
            } catch (err) {
                showToast("Error getting Drive folder.", 'error');
                throw err;
            }
        }

        function getJournalFileName() {
            return `faynalytics_journal_${googleUserId || 'local'}.json`;
        }
        
        async function saveJournalToDrive() {
            if (!googleAccessToken) return showToast("Please connect to Google Drive first.", 'warning');
            showLoading();
            try {
                const folderId = await getAppFolderId();
                const fileName = getJournalFileName();
                const fileContent = JSON.stringify(appState.journalEntries);
                
                const searchRes = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and name='${fileName}'`, fields: 'files(id)'
                });
                
                const fileId = searchRes.result.files.length > 0 ? searchRes.result.files[0].id : null;

                let metadata = { name: fileName, mimeType: 'application/json' };
                let url;
                let method;

                if (fileId) {
                    url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`;
                    method = 'PATCH';
                } else {
                    url = `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`;
                    method = 'POST';
                    metadata.parents = [folderId];
                }
                
                const blob = new Blob([fileContent], { type: 'application/json' });
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${googleAccessToken}` },
                    body: form
                });

                if (!res.ok) {
                    throw new Error(await res.text());
                }

                showToast("Journal saved successfully to Google Drive!", 'success');
            } catch (err) {
                console.error("Error saving to Drive:", err);
                showToast("Failed to save to Google Drive.", 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadJournalFromDrive() {
            if (!googleAccessToken) return showToast("Please connect to Google Drive first.", 'warning');
            showLoading();
            try {
                const folderId = await getAppFolderId();
                const fileName = getJournalFileName();
                
                const searchRes = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and name='${fileName}'`, fields: 'files(id)'
                });
                
                if (searchRes.result.files.length > 0) {
                    const fileId = searchRes.result.files[0].id;
                    const res = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                    
                    if (res.status === 200) {
                        try {
                            appState.journalEntries = res.result;
                            if (!Array.isArray(appState.journalEntries)) {
                                throw new Error('Loaded data is not an array.');
                            }

                            saveJournalEntriesLocallyOnly();
                            loadData();
                            showToast("Journal loaded from Google Drive!", 'success');
                        } catch (jsonErr) {
                            console.error("Failed to process data from Drive:", jsonErr);
                            showToast("Failed to load journal: invalid file format.", 'error');
                            appState.journalEntries = [];
                            saveJournalEntriesLocallyOnly();
                            loadData();
                        }
                    } else {
                        showToast("Journal file found but is empty or unreadable. Using local data.", 'info');
                        appState.journalEntries = [];
                        saveJournalEntriesLocallyOnly();
                        loadData();
                    }
                } else {
                    showToast("No journal file found on Google Drive. Using local data.", 'info');
                    loadJournalEntriesLocallyOnly();
                    loadData();
                }
            } catch (err) {
                console.error("Error loading from Drive:", err);
                showToast("Failed to load journal from Google Drive.", 'error');
            } finally {
                hideLoading();
            }
        }

        // ========================================================================
        // AUTRES FONCTIONS DE L'APPLICATION
        // ========================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            initializeEventListeners();
            loadData();
            setInitialDate();
        });

        function initializeApp() {
            document.documentElement.setAttribute('data-theme', appState.theme);
        }

        function initializeEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('settingsThemeToggle').addEventListener('click', toggleTheme);
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', handleNavigation);
            });
            
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            
            document.getElementById('currencyPair').addEventListener('change', updateCalculatorUI);
            document.getElementById('stopLossInputMethod').addEventListener('change', updateCalculatorUI);
            
            document.getElementById('journalAssetSelect').addEventListener('change', updateJournalUI);
            document.getElementById('filterAssetSelect').addEventListener('change', applyFiltersAndSort);
            document.getElementById('filterTradeType').addEventListener('change', applyFiltersAndSort);
            document.getElementById('sortBy').addEventListener('change', applyFiltersAndSort);
            document.getElementById('sortOrder').addEventListener('change', applyFiltersAndSort);
            
            setupGoogleAuthListeners();
        }

        function setupGoogleAuthListeners() {
            const authButton = document.getElementById('authorizeButton');
            const signoutButton = document.getElementById('signoutButton');
            const saveButton = document.getElementById('saveToDriveButton');
            const loadButton = document.getElementById('loadFromDriveButton');
            
            if (authButton) authButton.addEventListener('click', handleAuthClick);
            if (signoutButton) signoutButton.addEventListener('click', handleSignoutClick);
            if (saveButton) saveButton.addEventListener('click', saveJournalToDrive);
            if (loadButton) loadButton.addEventListener('click', loadJournalFromDrive);
        }

        function setInitialDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('journalDate').value = today;
        }

        function toggleTheme() {
            appState.theme = appState.theme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', appState.theme);
            localStorage.setItem('theme', appState.theme);
            showToast('Theme changed to ' + appState.theme + ' mode', 'info');
            updateAllCharts();
        }

        function handleNavigation(e) {
            e.preventDefault();
            const section = e.currentTarget.dataset.section;
            if (section) {
                showSection(section);
                updateActiveNav(e.currentTarget);
                closeSidebar();
            }
        }

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            const section = document.getElementById(sectionName + 'Section');
            if (section) {
                section.classList.add('active');
                appState.currentSection = sectionName;
                
                if (sectionName === 'analytics') {
                    setTimeout(() => {
                        updateAllCharts();
                        updateDetailedPerformanceTables();
                    }, 200);
                } else if (sectionName === 'dashboard') {
                    updateDashboardMetrics();
                } else if (sectionName === 'journal') {
                    applyFiltersAndSort();
                }
            }
        }

        function updateActiveNav(activeItem) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            activeItem.classList.add('active');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast card animate-fadeIn p-4 flex items-center gap-3`;
            toast.style.borderLeftWidth = '4px';
            
            const typeColor = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
            toast.style.borderLeftColor = typeColor;
            
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon} text-${type}-600"></i>
                <span class="text-sm">${message}</span>
            `;
            
            toastContainer.prepend(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function loadData() {
            loadJournalEntries();
            loadPerformanceGoal();
            applyFiltersAndSort();
            updateDashboardMetrics();
            updateAllCharts();
            updateDetailedPerformanceTables();
        }

        function loadJournalEntries() {
            if (googleAccessToken) {
                loadJournalFromDrive();
            } else {
                loadJournalEntriesLocallyOnly();
            }
        }

        function loadJournalEntriesLocallyOnly() {
            const storedEntries = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedEntries) {
                appState.journalEntries = JSON.parse(storedEntries);
            }
        }

        function saveJournalEntriesLocallyOnly() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState.journalEntries));
        }

        async function fetchUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                });
                if (response.ok) {
                    const userInfo = await response.json();
                    googleUserId = userInfo.id;
                    document.getElementById('userNameDisplay').textContent = `Welcome, ${userInfo.given_name || 'Trader'}!`;
                }
            } catch (error) {
                console.error('Failed to fetch user info:', error);
            }
        }
        
        async function getAppFolderId() {
            if (appFolderId) return appFolderId;
            try {
                const res = await gapi.client.drive.files.list({
                    q: `mimeType='application/vnd.google-apps.folder' and name='${APP_FOLDER_NAME}'`,
                    fields: 'files(id)'
                });
                if (res.result.files.length > 0) {
                    appFolderId = res.result.files[0].id;
                } else {
                    const createRes = await gapi.client.drive.files.create({
                        resource: { name: APP_FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' },
                        fields: 'id'
                    });
                    appFolderId = createRes.result.id;
                }
                return appFolderId;
            } catch (err) {
                showToast("Error getting Drive folder.", 'error');
                throw err;
            }
        }

        function getJournalFileName() {
            return `faynalytics_journal_${googleUserId || 'local'}.json`;
        }
        
        async function saveJournalToDrive() {
            if (!googleAccessToken) return showToast("Please connect to Google Drive first.", 'warning');
            showLoading();
            try {
                const folderId = await getAppFolderId();
                const fileName = getJournalFileName();
                const fileContent = JSON.stringify(appState.journalEntries);
                
                const searchRes = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and name='${fileName}'`, fields: 'files(id)'
                });
                
                const fileId = searchRes.result.files.length > 0 ? searchRes.result.files[0].id : null;

                let metadata = { name: fileName, mimeType: 'application/json' };
                let url;
                let method;

                if (fileId) {
                    url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`;
                    method = 'PATCH';
                } else {
                    url = `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`;
                    method = 'POST';
                    metadata.parents = [folderId];
                }
                
                const blob = new Blob([fileContent], { type: 'application/json' });
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${googleAccessToken}` },
                    body: form
                });

                if (!res.ok) {
                    throw new Error(await res.text());
                }

                showToast("Journal saved successfully to Google Drive!", 'success');
            } catch (err) {
                console.error("Error saving to Drive:", err);
                showToast("Failed to save to Google Drive.", 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadJournalFromDrive() {
            if (!googleAccessToken) return showToast("Please connect to Google Drive first.", 'warning');
            showLoading();
            try {
                const folderId = await getAppFolderId();
                const fileName = getJournalFileName();
                
                const searchRes = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and name='${fileName}'`, fields: 'files(id)'
                });
                
                if (searchRes.result.files.length > 0) {
                    const fileId = searchRes.result.files[0].id;
                    const res = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                    
                    if (res.status === 200) {
                        try {
                            appState.journalEntries = res.result;
                            if (!Array.isArray(appState.journalEntries)) {
                                throw new Error('Loaded data is not an array.');
                            }

                            saveJournalEntriesLocallyOnly();
                            loadData();
                            showToast("Journal loaded from Google Drive!", 'success');
                        } catch (jsonErr) {
                            console.error("Failed to process data from Drive:", jsonErr);
                            showToast("Failed to load journal: invalid file format.", 'error');
                            appState.journalEntries = [];
                            saveJournalEntriesLocallyOnly();
                            loadData();
                        }
                    } else {
                        showToast("Journal file found but is empty or unreadable. Using local data.", 'info');
                        appState.journalEntries = [];
                        saveJournalEntriesLocallyOnly();
                        loadData();
                    }
                } else {
                    showToast("No journal file found on Google Drive. Using local data.", 'info');
                    loadJournalEntriesLocallyOnly();
                    loadData();
                }
            } catch (err) {
                console.error("Error loading from Drive:", err);
                showToast("Failed to load journal from Google Drive.", 'error');
            } finally {
                hideLoading();
            }
        }

        function updateCalculatorUI() {
            const method = document.getElementById('stopLossInputMethod').value;
            document.getElementById('pipsDirectInputContainer').classList.toggle('hidden', method !== 'pips_direct');
            document.getElementById('priceBasedInputContainer').classList.toggle('hidden', method !== 'price_based');
            document.getElementById('customPipValueContainer').classList.toggle('hidden', document.getElementById('currencyPair').value !== 'custom');
        }

        function getPipDecimalValue(pair) {
            if (['USDJPY', 'EURJPY', 'GBPJPY'].includes(pair)) return 0.01;
            if (['XAUUSD'].includes(pair)) return 0.1;
            if (['DAX40', 'CAC40', 'SP500', 'NASDAQ100'].includes(pair)) return 1;
            return 0.0001;
        }
        
        function getPipValuePerLot(pair) {
            const values = {
                'EURUSD': 10, 'GBPUSD': 10, 'AUDUSD': 10, 'NZDUSD': 10, 'USDCAD': 10, 'USDCHF': 10,
                'USDJPY': 8.5, 'EURJPY': 8.5, 'GBPJPY': 8.5,
                'XAUUSD': 10, 'CAC40': 1, 'DAX40': 1, 'SP500': 1, 'NASDAQ100': 1
            };
            return values[pair] || parseFloat(document.getElementById('customPipValue').value) || 10;
        }

        function calculatePositionSize() {
            const capital = parseFloat(document.getElementById('capital').value);
            const riskPercentage = parseFloat(document.getElementById('riskPercentage').value);
            const currencyPair = document.getElementById('currencyPair').value;
            const stopLossMethod = document.getElementById('stopLossInputMethod').value;
            const errorDiv = document.getElementById('calcErrorMessage');
            const resultBox = document.getElementById('resultBox');
            let stopLossPips = 0;

            if (stopLossMethod === 'pips_direct') {
                stopLossPips = parseFloat(document.getElementById('stopLossPips').value);
            } else if (stopLossMethod === 'price_based') {
                const entryPrice = parseFloat(document.getElementById('entryPrice').value);
                const stopLossPrice = parseFloat(document.getElementById('stopLossPrice').value);
                if (isNaN(entryPrice) || isNaN(stopLossPrice)) {
                    errorDiv.textContent = 'Please enter valid entry and stop loss prices.';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                const pipDecimal = getPipDecimalValue(currencyPair);
                stopLossPips = Math.abs(entryPrice - stopLossPrice) / pipDecimal;
            }

            if (isNaN(capital) || isNaN(riskPercentage) || isNaN(stopLossPips) || capital <= 0 || riskPercentage <= 0 || stopLossPips <= 0) {
                errorDiv.textContent = 'Please fill all required fields with valid positive numbers.';
                errorDiv.classList.remove('hidden');
                resultBox.classList.add('hidden');
                return;
            }
            errorDiv.classList.add('hidden');
            
            const amountToRisk = (capital * riskPercentage) / 100;
            const pipValuePerLot = getPipValuePerLot(currencyPair);
            const lotSize = amountToRisk / (stopLossPips * pipValuePerLot);

            document.getElementById('lotSize').textContent = lotSize.toFixed(2);
            document.getElementById('pipValueDisplay').textContent = pipValuePerLot.toFixed(2);
            document.getElementById('amountRisqued').textContent = amountToRisk.toFixed(2);
            document.getElementById('calculatedPips').textContent = stopLossPips.toFixed(1);

            document.getElementById('calculatedPipsDisplay').classList.toggle('hidden', stopLossMethod !== 'price_based');
            resultBox.classList.remove('hidden');
        }

        function updateJournalUI() {
            const select = document.getElementById('journalAssetSelect');
            const customInput = document.getElementById('journalAssetCustom');
            customInput.classList.toggle('hidden', select.value !== 'other');
        }
        
        function getJournalFormData() {
            const form = document.getElementById('journalForm');
            const entry = {};
            const errorDiv = document.getElementById('journalErrorMessage');
            
            entry.date = form.journalDate.value;
            entry.asset = form.journalAssetSelect.value === 'other' ? form.journalAssetCustom.value.toUpperCase() : form.journalAssetSelect.value;
            entry.tradeType = form.journalTradeType.value;
            entry.setup = form.journalSetup.value;
            entry.entryPrice = parseFloat(form.journalEntryPrice.value);
            entry.stopLoss = parseFloat(form.journalSL.value);
            entry.takeProfit = parseFloat(form.journalTP.value);
            entry.rrr = form.journalRRR.value;
            entry.positionSize = parseFloat(form.journalPositionSize.value);
            entry.resultEuro = parseFloat(form.journalResultEuro.value) || 0;
            entry.resultPercentage = parseFloat(form.journalResultPercentage.value) || 0;
            entry.comment = form.journalComment.value;

            if (!entry.date || !entry.asset || isNaN(entry.entryPrice) || isNaN(entry.stopLoss) || isNaN(entry.takeProfit) || isNaN(entry.positionSize)) {
                errorDiv.textContent = 'Please fill in all required fields: Date, Asset, Entry, SL, TP, and Position Size.';
                errorDiv.classList.remove('hidden');
                return null;
            }
            errorDiv.classList.add('hidden');
            return entry;
        }

        function addUpdateJournalEntry(isDraft) {
            const entry = getJournalFormData();
            if (!entry) return;
            entry.is_draft = isDraft;
            
            if (appState.editingEntryIndex !== -1) {
                appState.journalEntries[appState.editingEntryIndex] = { ...appState.journalEntries[appState.editingEntryIndex], ...entry };
                showToast("Entry updated successfully!", 'success');
            } else {
                entry.timestamp = new Date().toISOString();
                appState.journalEntries.unshift(entry);
                showToast(isDraft ? "Draft saved!" : "Trade added to journal!", 'success');
            }
            
            saveJournalEntriesLocallyOnly();
            loadData();
            resetJournalForm();
        }

        function editJournalEntry(index) {
            const entry = appState.journalEntries[index];
            const form = document.getElementById('journalForm');
            form.journalDate.value = entry.date;
            form.journalAssetSelect.value = ['EURUSD', 'GBPUSD', 'USDJPY', 'AUDUSD', 'USDCAD', 'USDCHF', 'NZDUSD', 'EURJPY', 'GBPJPY', 'XAUUSD', 'DAX40', 'SP500', 'NASDAQ100', 'CAC40'].includes(entry.asset) ? entry.asset : 'other';
            document.getElementById('journalAssetCustom').value = form.journalAssetSelect.value === 'other' ? entry.asset : '';
            updateJournalUI();
            form.journalTradeType.value = entry.tradeType;
            form.journalSetup.value = entry.setup;
            form.journalEntryPrice.value = entry.entryPrice;
            form.journalSL.value = entry.stopLoss;
            form.journalTP.value = entry.takeProfit;
            form.journalRRR.value = entry.rrr;
            form.journalPositionSize.value = entry.positionSize;
            form.journalResultEuro.value = entry.resultEuro;
            form.journalResultPercentage.value = entry.resultPercentage;
            form.journalComment.value = entry.comment;
            
            appState.editingEntryIndex = index;
            document.querySelector('#journalSection .btn-success').classList.add('hidden');
            document.querySelector('#journalSection .btn-info').classList.add('hidden');
            document.getElementById('cancelEditBtn').classList.remove('hidden');
        }

        function deleteJournalEntry(index) {
            if (confirm('Are you sure you want to delete this entry?')) {
                appState.journalEntries.splice(index, 1);
                saveJournalEntriesLocallyOnly();
                loadData();
                showToast("Trade deleted.", 'success');
            }
        }

        function cancelEdit() {
            resetJournalForm();
        }

        function resetJournalForm() {
            document.getElementById('journalForm').reset();
            document.getElementById('journalAssetCustom').classList.add('hidden');
            document.querySelector('#journalSection .btn-success').classList.remove('hidden');
            document.querySelector('#journalSection .btn-info').classList.remove('hidden');
            document.getElementById('cancelEditBtn').classList.add('hidden');
            appState.editingEntryIndex = -1;
            setInitialDate();
        }

        function applyFiltersAndSort() {
            let filtered = appState.journalEntries.filter(e => !e.is_draft);
            const filterAsset = document.getElementById('filterAssetSelect').value;
            const filterType = document.getElementById('filterTradeType').value;
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;

            if (filterAsset) filtered = filtered.filter(e => e.asset === filterAsset);
            if (filterType) filtered = filtered.filter(e => e.tradeType === filterType);
            
            filtered.sort((a, b) => {
                let valA = a[sortBy];
                let valB = b[sortBy];
                if (sortBy === 'timestamp' || sortBy === 'date') {
                    valA = new Date(valA).getTime();
                    valB = new Date(valB).getTime();
                } else if (typeof valA === 'string') {
                    return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(a);
                }
                return sortOrder === 'asc' ? valA - valB : valB - valA;
            });

            renderJournalEntries(filtered);
        }
        
        function resetFiltersAndSort() {
            document.getElementById('filterAssetSelect').value = '';
            document.getElementById('filterTradeType').value = '';
            document.getElementById('sortBy').value = 'timestamp';
            document.getElementById('sortOrder').value = 'desc';
            applyFiltersAndSort();
        }

        function renderJournalEntries(entriesToRender) {
            const container = document.getElementById('journalEntriesContainer');
            const message = document.getElementById('noEntriesMessage');
            container.innerHTML = '';
            
            message.classList.toggle('hidden', entriesToRender.length > 0);

            entriesToRender.forEach((entry, index) => {
                const entryDiv = document.createElement('div');
                const resultClass = entry.resultEuro >= 0 ? 'border-green-500' : 'border-red-500';
                
                entryDiv.className = `journal-entry-card card p-6 ${resultClass}`;
                
                entryDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-semibold text-xl">${entry.asset} <span class="text-sm font-normal text-gray-500">(${entry.tradeType})</span></p>
                            <p class="text-sm text-gray-500">${entry.date}</p>
                        </div>
                        <p class="font-bold text-3xl ${entry.resultEuro >= 0 ? 'text-green-600' : 'text-red-600'}">${entry.resultEuro.toFixed(2)}€</p>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Setup: ${entry.setup || 'N/A'}</p>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm text-gray-700 dark:text-gray-300">
                        <div><span class="font-medium">Entry:</span> ${entry.entryPrice}</div>
                        <div><span class="font-medium">SL:</span> ${entry.stopLoss}</div>
                        <div><span class="font-medium">TP:</span> ${entry.takeProfit}</div>
                        <div><span class="font-medium">RRR:</span> ${entry.rrr || 'N/A'}</div>
                        <div><span class="font-medium">Size:</span> ${entry.positionSize} lots</div>
                    </div>
                    ${entry.comment ? `<p class="mt-4 text-sm text-gray-700 dark:text-gray-300">Notes: ${entry.comment}</p>` : ''}
                    <div class="mt-4 flex justify-end gap-2">
                        <button onclick="editJournalEntry(${appState.journalEntries.indexOf(entry)})" class="btn btn-info text-sm py-2 px-4">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="deleteJournalEntry(${appState.journalEntries.indexOf(entry)})" class="btn btn-danger text-sm py-2 px-4">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                container.appendChild(entryDiv);
            });
        }
        
        function updateDashboardMetrics() {
            const nonDraftEntries = appState.journalEntries.filter(e => !e.is_draft);
            const totalTrades = nonDraftEntries.length;
            const winningTrades = nonDraftEntries.filter(e => e.resultEuro > 0).length;
            const totalPnL = nonDraftEntries.reduce((sum, e) => sum + (e.resultEuro || 0), 0);
            const avgPnL = totalTrades > 0 ? totalPnL / totalTrades : 0;
            const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100) : 0;

            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winRate').textContent = `${winRate.toFixed(2)}%`;
            document.getElementById('totalPnL').textContent = `€${totalPnL.toFixed(2)}`;
            document.getElementById('avgPnL').textContent = `€${avgPnL.toFixed(2)}`;
            
            document.getElementById('totalPnL').style.color = totalPnL >= 0 ? 'var(--success)' : 'var(--danger)';
            document.getElementById('avgPnL').style.color = avgPnL >= 0 ? 'var(--success)' : 'var(--danger)';
            document.getElementById('winRate').style.color = winRate >= 50 ? 'var(--success)' : 'var(--danger)';

            updatePerformanceGoalDisplay();
        }

        function updatePerformanceGoalDisplay() {
            const nonDraftEntries = appState.journalEntries.filter(e => !e.is_draft);
            const currentPnL = nonDraftEntries.reduce((sum, e) => sum + (e.resultEuro || 0), 0);
            const progress = (currentPnL / appState.targetPnLEuro) * 100;
            
            const progressBar = document.getElementById('goalProgressBar');
            const progressText = document.getElementById('currentGoalProgress');
            
            const sanitizedProgress = Math.min(100, Math.max(0, progress));
            progressBar.style.width = `${sanitizedProgress}%`;
            progressText.textContent = `${sanitizedProgress.toFixed(2)}%`;
            
            if (progress >= 100) {
                progressBar.style.background = `linear-gradient(90deg, var(--success), #059669)`;
                if (document.getElementById('goalNotifications').checked) {
                    showToast("Congratulations! You've reached your performance goal!", 'success', 5000);
                }
            } else {
                progressBar.style.background = `linear-gradient(90deg, var(--accent-secondary), var(--accent-primary))`;
            }

            document.getElementById('goalProgressDisplay').classList.remove('hidden');
        }

        function setPerformanceGoal() {
            const initialCapitalInput = document.getElementById('initialCapital');
            const targetPnLInput = document.getElementById('targetPnLEuro');
            
            const initialCap = parseFloat(initialCapitalInput.value);
            const targetPnL = parseFloat(targetPnLInput.value);

            if (isNaN(initialCap) || initialCap <= 0 || isNaN(targetPnL) || targetPnL <= 0) {
                showToast("Please enter valid positive numbers for your goal.", 'error');
                return;
            }
            
            appState.initialCapital = initialCap;
            appState.targetPnLEuro = targetPnL;
            localStorage.setItem(GOAL_STORAGE_KEY, JSON.stringify({
                initialCapital: initialCap,
                targetPnLEuro: targetPnL
            }));
            
            updatePerformanceGoalDisplay();
            showToast("Performance goal updated successfully!", 'success');
        }
        
        function loadPerformanceGoal() {
            const storedGoal = localStorage.getItem(GOAL_STORAGE_KEY);
            if (storedGoal) {
                const goal = JSON.parse(storedGoal);
                appState.initialCapital = goal.initialCapital;
                appState.targetPnLEuro = goal.targetPnLEuro;
                document.getElementById('initialCapital').value = appState.initialCapital;
                document.getElementById('targetPnLEuro').value = appState.targetPnLEuro;
            }
        }
        
        function updateAllCharts() {
            const nonDraftEntries = appState.journalEntries.filter(e => !e.is_draft).sort((a, b) => new Date(a.date) - new Date(b.date));
            const assetData = nonDraftEntries.reduce((acc, entry) => {
                acc[entry.asset] = (acc[entry.asset] || 0) + entry.resultEuro;
                return acc;
            }, {});

            const cumulativePnL = nonDraftEntries.reduce((acc, entry) => {
                const last = acc.length > 0 ? acc[acc.length - 1] : 0;
                acc.push(last + entry.resultEuro);
                return acc;
            }, []);

            if (appState.charts.equity) appState.charts.equity.destroy();
            if (appState.charts.asset) appState.charts.asset.destroy();
            
            appState.charts.equity = new Chart(document.getElementById('equityCurveChart'), {
                type: 'line',
                data: {
                    labels: nonDraftEntries.map(e => e.date),
                    datasets: [{
                        label: 'Equity Curve (€)',
                        data: cumulativePnL,
                        borderColor: 'rgb(124, 58, 237)',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        tension: 0.2,
                        fill: true,
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: 'rgba(100, 116, 139, 0.2)' } },
                        y: { grid: { color: 'rgba(100, 116, 139, 0.2)' } }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary')
                            }
                        }
                    }
                }
            });

            appState.charts.asset = new Chart(document.getElementById('assetPerformanceChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(assetData),
                    datasets: [{
                        label: 'P&L (€)',
                        data: Object.values(assetData),
                        backgroundColor: Object.values(assetData).map(v => v >= 0 ? 'rgb(16, 185, 129)' : 'rgb(239, 68, 68)'),
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: 'rgba(100, 116, 139, 0.2)' } },
                        y: { grid: { color: 'rgba(100, 116, 139, 0.2)' } }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary')
                            }
                        }
                    }
                }
            });

            const sessions = [
                { name: 'London', start: 8, end: 16, color: '#7c3aed' },
                { name: 'New York', start: 13, end: 21, color: '#8b5cf6' },
                { name: 'Tokyo', start: 0, end: 9, color: '#3b82f6' },
                { name: 'Sydney', start: 22, end: 7, color: '#2563eb' }
            ];
            
            const sessionsData = sessions.flatMap(s => {
                if (s.start < s.end) {
                    return [{ y: s.name, x: [s.start, s.end] }];
                } else {
                    return [{ y: s.name, x: [s.start, 24] }, { y: s.name, x: [0, s.end] }];
                }
            });

            const sessionsColors = sessions.flatMap(s => {
                if (s.start < s.end) {
                    return [s.color];
                } else {
                    return [s.color, s.color];
                }
            });

            if (appState.charts.sessions) appState.charts.sessions.destroy();
            const now = new Date();
            const utcHour = now.getUTCHours() + now.getUTCMinutes() / 60;
            
            const currentHourLine = {
                id: 'currentHourLine',
                beforeDraw: (chart) => {
                    const { ctx, chartArea: { top, bottom, left, right }, scales: { x } } = chart;
                    const pixel = x.getPixelForValue(utcHour);

                    ctx.save();
                    ctx.beginPath();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = 'red';
                    ctx.setLineDash([5, 5]);
                    ctx.moveTo(pixel, top);
                    ctx.lineTo(pixel, bottom);
                    ctx.stroke();
                    ctx.restore();
                }
            };

            appState.charts.sessions = new Chart(document.getElementById('tradingSessionsChartCanvas'), {
                type: 'bar',
                data: {
                    labels: sessions.map(s => s.name),
                    datasets: [{
                        label: 'Trading Session',
                        data: sessionsData,
                        backgroundColor: sessionsColors
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            min: 0,
                            max: 24,
                            title: {
                                display: true,
                                text: 'Time (UTC)'
                            },
                            grid: {
                                color: 'rgba(100, 116, 139, 0.2)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Session'
                            },
                            grid: {
                                color: 'rgba(100, 116, 139, 0.2)'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const { y, x } = context.raw;
                                    return `${y}: ${x[0].toFixed(0)}:00 - ${x[1].toFixed(0)}:00 UTC`;
                                }
                            }
                        }
                    }
                },
                plugins: [currentHourLine]
            });
        }
        
        function updateDetailedPerformanceTables() {
            const nonDraftEntries = appState.journalEntries.filter(e => !e.is_draft);
            const assetData = nonDraftEntries.reduce((acc, entry) => {
                acc[entry.asset] = acc[entry.asset] || { totalTrades: 0, wins: 0, pnl: 0, pnlPercent: 0 };
                acc[entry.asset].totalTrades++;
                if (entry.resultEuro > 0) acc[entry.asset].wins++;
                acc[entry.asset].pnl += entry.resultEuro;
                acc[entry.asset].pnlPercent += entry.resultPercentage;
                return acc;
            }, {});

            const tradeTypeData = nonDraftEntries.reduce((acc, entry) => {
                acc[entry.tradeType] = acc[entry.tradeType] || { totalTrades: 0, wins: 0, pnl: 0, pnlPercent: 0 };
                acc[entry.tradeType].totalTrades++;
                if (entry.resultEuro > 0) acc[entry.tradeType].wins++;
                acc[entry.tradeType].pnl += entry.resultEuro;
                acc[entry.tradeType].pnlPercent += entry.resultPercentage;
                return acc;
            }, {});

            const renderTable = (containerId, data, title) => {
                const container = document.getElementById(containerId);
                if (Object.keys(data).length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-600 dark:text-gray-400 p-4">No ${title.toLowerCase()} data available.</p>`;
                    return;
                }
                
                let tableHtml = `<table class="table w-full"><thead><tr><th>${title}</th><th>Trades</th><th>Win Rate</th><th>P&L (€)</th></tr></thead><tbody>`;
                for (const key in data) {
                    const stats = data[key];
                    const winRate = stats.totalTrades > 0 ? (stats.wins / stats.totalTrades * 100).toFixed(2) : 0;
                    const pnlClass = stats.pnl >= 0 ? 'text-green-600' : 'text-red-600';
                    tableHtml += `<tr><td>${key}</td><td>${stats.totalTrades}</td><td>${winRate}%</td><td class="${pnlClass}">${stats.pnl.toFixed(2)}€</td></tr>`;
                }
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            };

            renderTable('performanceByAssetTable', assetData, 'Asset');
            renderTable('performanceByTradeTypeTable', tradeTypeData, 'Trade Type');
        }

        function updateTradingSessionStatus() {
            const now = new Date();
            const utcHour = now.getUTCHours();
            const sessions = {
                london: { start: 8, end: 16 },
                newYork: { start: 13, end: 21 },
                tokyo: { start: 0, end: 9 },
                sydney: { start: 22, end: 7 }
            };
            
            for (const name in sessions) {
                const session = sessions[name];
                const element = document.getElementById(name + 'Status');
                let isOpen = false;
                if (session.start < session.end) {
                    isOpen = utcHour >= session.start && utcHour < session.end;
                } else {
                    isOpen = utcHour >= session.start || utcHour < session.end;
                }
                
                element.classList.remove('online', 'offline');
                element.classList.add(isOpen ? 'online' : 'offline');
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(appState.journalEntries, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'faynalytics_journal_export.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast("Data exported successfully!", 'success');
        }
        
        function importData() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const importedData = JSON.parse(event.target.result);
                            if (Array.isArray(importedData)) {
                                appState.journalEntries = importedData;
                                saveJournalEntriesLocallyOnly();
                                loadData();
                                showToast("Data imported successfully!", 'success');
                            } else {
                                throw new Error('Invalid file format.');
                            }
                        } catch (err) {
                            showToast("Failed to import data. Invalid file.", 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            fileInput.click();
        }

        function clearAllData() {
            if (confirm("Are you sure you want to clear all local data? This action cannot be undone.")) {
                appState.journalEntries = [];
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                loadData();
                showToast("All local data has been cleared.", 'success');
            }
        }
    </script>
</body>
</html>
